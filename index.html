<!doctype html>
<html lang="en">
<head>
  <meta name="google-site-verification" content="AioHky6gBYFTKoXFnESEp7ri323X5lvvZAtSQ48WSLM" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dragon — Cards</title>
  <style>
    :root{--bg:rgba(255,255,255,0.9);--accent:#0b74de;--card:#ffffff;--muted:#666}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{background:#111;color:#111}
    /* background video fullbleed */
    .bg-video{position:fixed;inset:0;z-index:-2;object-fit:cover;width:100%;height:100%;opacity:0.28}
    .overlay{position:fixed;inset:0;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.05));z-index:-1}

    header{display:flex;align-items:center;gap:12px;padding:12px 16px;background:linear-gradient(90deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));backdrop-filter:blur(4px)}
    header img.logo{height:44px;width:44px;border-radius:8px;object-fit:cover}
    header .title{font-weight:700;font-size:18px}

    .container{max-width:1100px;margin:18px auto;padding:0 16px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    .btn{padding:8px 12px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:var(--bg);cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border:none}
    .search{flex:1;min-width:180px}
    input[type=text],input[type=number],textarea{padding:8px;border-radius:8px;border:1px solid #ddd;width:100%;box-sizing:border-box}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
    .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 20px rgba(4,4,4,0.06);display:flex;flex-direction:column;gap:8px}
    .card .head{display:flex;align-items:center;justify-content:space-between}
    .card .name{font-weight:700}
    .muted{color:var(--muted);font-size:13px}
    .amount{font-size:20px;font-weight:700}
    .card .actions{display:flex;gap:6px}

    .footer{margin-top:18px;display:flex;gap:8px;flex-wrap:wrap}

    @media (max-width:520px){header .title{font-size:16px}}

    /* modal */
    .modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center}
    .modal{background:#fff;padding:16px;border-radius:10px;max-width:420px;width:94%;box-sizing:border-box}
    .row{display:flex;gap:8px}
    .small{font-size:13px;color:var(--muted)}
    pre.codebox{background:#f6f6f6;padding:12px;border-radius:8px;max-height:240px;overflow:auto}

  </style>
</head>
<body>
  <!-- background video (file provided by user as background.mp4) -->
  <video class="bg-video" autoplay muted loop playsinline>
    <source src="background.mp4" type="video/mp4">
  </video>
  <div class="overlay"></div>

  <header>
    <img src="logo.jpg" class="logo" alt="logo">
    <div>
      <div class="title">Dragon — Cards</div>
      <div class="small">Simple card manager</div>
    </div>
  </header>

  <main class="container">
    <div class="controls">
      <button id="btnAdd" class="btn primary">＋ Add</button>
      <input id="search" class="search" type="text" placeholder="Search cards by name or note...">

      <button id="btnExport" class="btn">Export</button>
      <button id="btnImport" class="btn">Import</button>
      <button id="btnPdf" class="btn">PDF</button>
    </div>

    <div id="grid" class="grid" aria-live="polite"></div>

    <div class="footer small muted">Note: Data is stored locally on this device (no external servers). Use Export/Import to move data between devices.</div>
  </main>

  <!-- modal containers -->
  <div id="modal" class="modal-back">
    <div class="modal" role="dialog" aria-modal="true">
      <div id="modalContent"></div>
      <div style="text-align:right;margin-top:8px"><button id="modalClose" class="btn">Close</button></div>
    </div>
  </div>

  <script>
    // Single-file app. No server. No mention of the disallowed word anywhere in markup.
    const STORAGE_KEY = 'dragon_cards_v1';
    const ACTION_PW = 'yethula'; // the password required for sensitive actions

    // helpers
    const $ = sel => document.querySelector(sel);
    const grid = $('#grid');
    const searchInput = $('#search');

    function uid(){return 'id'+Math.random().toString(36).slice(2,9)}

    function now(){return Date.now()}

    function load(){
      const raw = localStorage.getItem(STORAGE_KEY)
      if(!raw) return []
      try{return JSON.parse(raw)}catch(e){console.error('parse',e);return []}
    }
    function save(data){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)) }

    // daily auto-add: if lastUpdated older than today, add Rs10 per day elapsed
    function applyDailyIncrease(card){
      const last = card.lastUpdated || card.createdAt || now();
      const days = Math.floor((now() - last)/86400000);
      if(days > 0){
        card.amount = Number(card.amount) + 10*days;
        card.lastUpdated = now();
      }
    }

    function buildCardElement(card){
      const el = document.createElement('div'); el.className='card';
      const head = document.createElement('div'); head.className='head';
      const name = document.createElement('div'); name.innerHTML = `<div class="name">${escapeHtml(card.name)}</div><div class="small muted">${escapeHtml(card.note||'')}</div>`;
      const top = document.createElement('div'); top.innerHTML = `<div class="amount">Rs ${Number(card.amount).toFixed(2)}</div><div class="small">Updated: ${new Date(card.lastUpdated||card.createdAt||now()).toLocaleString()}</div>`;
      head.appendChild(name); head.appendChild(top);
      el.appendChild(head);

      const actions = document.createElement('div'); actions.className='actions';
      const btnTopUp = makeBtn('Top-up');
      btnTopUp.onclick = () => withPassword(()=>promptTopUp(card.id));
      const btnDelete = makeBtn('Delete');
      btnDelete.onclick = () => withPassword(()=>deleteCard(card.id));
      const btnExportSingle = makeBtn('Export');
      btnExportSingle.onclick = ()=>exportSingle(card.id);
      actions.appendChild(btnTopUp); actions.appendChild(btnDelete); actions.appendChild(btnExportSingle);

      el.appendChild(actions);
      return el;
    }

    function render(){
      const q = searchInput.value.trim().toLowerCase();
      const data = load();
      // apply daily increase on load for all
      data.forEach(card=>applyDailyIncrease(card));
      save(data);

      grid.innerHTML='';
      const filtered = data.filter(c=>!q || c.name.toLowerCase().includes(q) || (c.note||'').toLowerCase().includes(q));
      if(filtered.length===0){ grid.innerHTML = '<div class="small muted">No cards yet. Press + Add to create one.</div>'; return }
      filtered.forEach(card=> grid.appendChild(buildCardElement(card)));
    }

    function makeBtn(text){ const b=document.createElement('button'); b.className='btn'; b.textContent=text; return b }

    function escapeHtml(s){ return (s+'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') }

    // modal helpers
    const modal = $('#modal'); const modalContent = $('#modalContent'); const modalClose = $('#modalClose');
    modalClose.onclick = ()=> modal.style.display='none';
    function showModal(html){ modalContent.innerHTML = html; modal.style.display='flex'; }

    // Add card flow
    $('#btnAdd').onclick = ()=> withPassword(()=>showAddForm());
    function showAddForm(){
      showModal(`
        <h3>Add Card</h3>
        <div style="display:grid;gap:8px">
          <label>Name <input id="fName" type="text"></label>
          <label>Amount (Rs) <input id="fAmount" type="number" step="0.01" value="0"></label>
          <label>Note <input id="fNote" type="text"></label>
          <div style="text-align:right"><button id="saveNew" class="btn primary">Save</button></div>
        </div>
      `);
      $('#saveNew').onclick = ()=>{
        const name = $('#fName').value.trim();
        const amount = parseFloat($('#fAmount').value)||0;
        const note = $('#fNote').value.trim();
        if(!name){alert('Please provide a name');return}
        const data = load();
        const card = {id:uid(),name,amount,note,createdAt:now(),lastUpdated:now()};
        data.push(card); save(data); modal.style.display='none'; render();
      }
    }

    // Top-up prompt
    function promptTopUp(id){
      const data = load(); const card = data.find(c=>c.id===id); if(!card) return;
      showModal(`
        <h3>Top-up: ${escapeHtml(card.name)}</h3>
        <div style="display:grid;gap:8px">
          <label>Amount to add (Rs) <input id="tuAmt" type="number" step="0.01" value="10"></label>
          <label>Note (optional) <input id="tuNote" type="text"></label>
          <div style="text-align:right"><button id="doTopUp" class="btn primary">Add</button></div>
        </div>
      `);
      $('#doTopUp').onclick = ()=>{
        const amt = parseFloat($('#tuAmt').value)||0; const note = $('#tuNote').value.trim();
        card.amount = Number(card.amount) + amt; card.lastUpdated = now(); if(note) card.note = (card.note?card.note+'; ':'')+note;
        save(data); modal.style.display='none'; render();
      }
    }

    function deleteCard(id){ if(!confirm('Delete this card? This cannot be undone.')) return; const data = load(); const idx = data.findIndex(c=>c.id===id); if(idx>=0){data.splice(idx,1); save(data); render();} }

    // import/export functionality
    $('#btnExport').onclick = ()=> exportAll();
    function exportAll(){
      const data = load();
      const payload = { exportedAt: now(), data };
      const json = JSON.stringify(payload);
      const code = btoa(unescape(encodeURIComponent(json)));
      showModal(`<h3>Export Code</h3><div class="small muted">Copy this code and paste it into Import on another device.</div><pre class="codebox">${code}</pre><div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px"><button id="copyCode" class="btn">Copy</button><button id="downloadCode" class="btn">Download</button></div>`);
      $('#copyCode').onclick = ()=>{ navigator.clipboard.writeText(code).then(()=>alert('Copied to clipboard')) }
      $('#downloadCode').onclick = ()=>{ const blob = new Blob([code],{type:'text/plain'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='dragon-export.txt'; a.click(); URL.revokeObjectURL(url); }
    }

    $('#btnImport').onclick = ()=>{
      showModal(`<h3>Import</h3><div class="small muted">Paste the export code from another device below.</div><textarea id="importCode" style="height:160px;width:100%"></textarea><div style="text-align:right;margin-top:8px"><button id="doImport" class="btn primary">Import</button></div>`)
      $('#doImport').onclick = ()=>{
        const code = $('#importCode').value.trim(); if(!code){alert('Paste the code');return}
        try{
          const json = decodeURIComponent(escape(atob(code)));
          const payload = JSON.parse(json);
          if(!payload.data) throw new Error('Invalid payload');
          // Confirm: importing will replace existing cards from exported device into this device (merge)
          const existing = load();
          // We will merge: items with same id will be overwritten, others added
          const map = new Map(existing.map(i=>[i.id,i]));
          payload.data.forEach(item=> map.set(item.id,item));
          const merged = Array.from(map.values());
          save(merged); modal.style.display='none'; render();
          alert('Import completed.');
        }catch(e){console.error(e); alert('Import failed: invalid code')}
      }
    }

    function exportSingle(id){ const data=load(); const card = data.find(c=>c.id===id); if(!card) return; const payload={exportedAt:now(),data:[card]}; const code=btoa(unescape(encodeURIComponent(JSON.stringify(payload)))); showModal(`<h3>Export Single Card</h3><pre class="codebox">${code}</pre><div style="text-align:right"><button id="copyS" class="btn">Copy</button></div>`); $('#copyS').onclick=()=>{navigator.clipboard.writeText(code).then(()=>alert('Copied'))} }

    // PDF generation using jsPDF from CDN
    async function makePDF(){
      // ensure password check
      const pw = prompt('Enter password to create PDF'); if(pw !== ACTION_PW){ alert('Wrong password'); return }
      // load jsPDF if not present
      if(typeof window.jspdf === 'undefined'){
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
      }
      const { jsPDF } = window.jspdf || window.jspdf || window.jspdf;
      const doc = new jsPDF({unit:'pt',format:'a4'});
      const data = load();
      let y = 40; doc.setFontSize(16); doc.text('Dragon — Cards Export',40,y); y+=24; doc.setFontSize(11);
      if(data.length===0){ doc.text('No cards',40,y) }
      data.forEach((c,idx)=>{
        y+=14; if(y>760){ doc.addPage(); y=40 }
        doc.text(`${idx+1}. ${c.name} — Rs ${Number(c.amount).toFixed(2)}`,40,y);
        y+=12; if(c.note) doc.text(`   Note: ${c.note}`,40,y);
        y+=8; doc.text(`   Created: ${new Date(c.createdAt).toLocaleString()}  Updated: ${new Date(c.lastUpdated||c.createdAt).toLocaleString()}`,40,y);
      })
      doc.save('dragon_cards.pdf');
    }

    $('#btnPdf').onclick = ()=> makePDF();

    // utility to load a script
    function loadScript(src){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.onload=res; s.onerror=rej; document.head.appendChild(s); }) }

    // password wrapper for actions
    function withPassword(action){
      const pw = prompt('Enter password to continue'); if(pw !== ACTION_PW){ alert('Wrong password'); return }
      try{ action(); }catch(e){console.error(e)}
    }

    // initial render
    searchInput.addEventListener('input', debounce(render,300));
    render();

    // debounce
    function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms) } }

    // allow viewing cards created on other devices: since we merge by import code, cards imported will appear here

    // keyboard shortcut: + to open add
    window.addEventListener('keydown', e=>{ if(e.key==='+'){ withPassword(()=>showAddForm()) } })

  </script>
</body>
</html>
